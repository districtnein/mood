---
import feed from "../data/feed.json";
const title = feed.title ?? "moodboard";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <style>
     :root{
  --pad: 24px;
  --gap: 16px;
  --single-max: 900px; /* max width for 1-image rows */
}

body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: white;
  color: black;
}

header{
  position: sticky;
  top: 0;
  z-index: 20;
  padding: var(--pad);
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,0.7);
}

h1{
  margin:0;
  font-size:14px;
  font-weight:500;
  letter-spacing:0.02em;
}

main{
  padding: 0 var(--pad) var(--pad);
}

/* =========================
   EDITORIAL ROW LAYOUT
   (no grid, no columns)
   ========================= */

:global(#grid){
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}

/* each row container */
:global(.row){
  display: flex;
  gap: var(--gap);
  align-items: flex-start;
  width: 100%;
}

/* make images behave */
:global(.row img){
  display: block;
  height: auto;
  max-width: 100%;
  border-radius: 0;
}

/* 1-image row: centered, capped width */
:global(.row[data-layout="1"]){
  justify-content: center;
}
:global(.row[data-layout="1"] img){
  width: 100%;
  max-width: var(--single-max);
}

/* 2-image row */
:global(.row[data-layout="2"] img){
  width: calc(50% - (var(--gap) / 2));
}

/* 3-image row */
:global(.row[data-layout="3"] img){
  width: calc(33.333% - (var(--gap) * 2 / 3));
}

/* mobile: always stack to 1 per row */
@media (max-width: 700px){
  :global(.row){
    flex-direction: column;
  }
  :global(.row img){
    width: 100% !important;
    max-width: none !important;
  }
}

/* sentinel + status */
.sentinel{ height: 1px; }
.status{ padding-top: 10px; font-size: 12px; opacity: 0.55; }
    </style>
  </head>

  <body>
    <header>
      <h1>{title}</h1>
    </header>

    <main>
      <section id="grid" class="masonry" aria-label="Moodboard"></section>
      <div id="sentinel" class="sentinel" aria-hidden="true"></div>
      <div id="status" class="status" aria-live="polite"></div>
    </main>

    <script>
      const grid = document.getElementById("grid");
      const sentinel = document.getElementById("sentinel");
      const statusEl = document.getElementById("status");

      let page = 1;
      let loading = false;
      let hasMore = true;

      function el(tag, attrs = {}) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (v === undefined || v === null || v === "") continue;
          node.setAttribute(k, v);
        }
        return node;
      }

      function renderItems(items) {
        const frag = document.createDocumentFragment();

        for (const it of items) {
          const img = el("img", {
            src: it.src,
            alt: it.alt || "",
            loading: "lazy",
            decoding: "async",
            width: it.w || "",
            height: it.h || ""
          });

          const card = document.createElement("div");
          card.className = "card";
          card.dataset.span = String(it.span || 1); // 1, 2, or 3

          card.appendChild(img);
          frag.appendChild(card);
        }

        grid.appendChild(frag);
      }

      async function loadNext() {
        if (loading || !hasMore) return;
        loading = true;
        statusEl.textContent = "Loading…";

        try {
          const res = await fetch(`/api/feed.json?page=${page}&pageSize=36`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          renderItems(data.items);
          hasMore = Boolean(data.hasMore);
          page += 1;

          statusEl.textContent = hasMore ? "" : "End.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Couldn’t load more.";
        } finally {
          loading = false;
        }
      }

      const io = new IntersectionObserver(
        (entries) => {
          if (entries.some((e) => e.isIntersecting)) loadNext();
        },
        { rootMargin: "800px" }
      );

      io.observe(sentinel);
      loadNext();
    </script>
  </body>
</html>
