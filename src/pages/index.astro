---
import feed from "../data/feed.json";
const title = feed.title ?? "moodboard";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <style>
      :root{
        --pad: 24px;
        --gap: 16px;
        --single-max: 900px; /* cap for "one big image" rows */
      }

      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background:white;
        color:black;
      }

      header{
        position: sticky;
        top: 0;
        z-index: 20;
        padding: var(--pad);
        backdrop-filter: blur(10px);
        background: rgba(255,255,255,0.7);
      }

      h1{
        margin:0;
        font-size:14px;
        font-weight:500;
        letter-spacing:0.02em;
      }

      main{
        padding: 0 var(--pad) var(--pad);
      }

      /* =========================
         NO-GRID LAYOUT (flex wrap)
         ========================= */

      :global(#grid.masonry){
        display: flex;
        flex-wrap: wrap;
        gap: var(--gap);
        align-items: flex-start;
      }

      /* base card */
      :global(#grid.masonry > .card){
        display: block;
      }

      /* desktop sizing driven by span
         span 1 -> 3-ish across
         span 2 -> 2-ish across
         span 3 -> single (but capped + centered)
      */
      @media (min-width: 900px){
        :global(#grid.masonry > .card[data-span="1"]){
          flex: 1 1 calc(33.333% - (var(--gap) * 2 / 3));
        }

        :global(#grid.masonry > .card[data-span="2"]){
          flex: 1 1 calc(50% - (var(--gap) / 2));
        }

        :global(#grid.masonry > .card[data-span="3"]){
          flex: 1 1 100%;
          max-width: var(--single-max);
          margin-left: auto;
          margin-right: auto;
        }
      }

      /* mobile: always single column */
      @media (max-width: 899px){
        :global(#grid.masonry > .card){
          flex: 1 1 100%;
        }
      }

      :global(#grid.masonry img){
        display:block;
        width:100%;
        height:auto;
        border-radius: 0px; /* set to 6px etc if you want */
      }

      .sentinel{ height:1px; }
      .status{ padding-top:10px; font-size:12px; opacity:0.55; }
    </style>
  </head>

  <body>
    <header>
      <h1>{title}</h1>
    </header>

    <main>
      <section id="grid" class="masonry" aria-label="Moodboard"></section>
      <div id="sentinel" class="sentinel" aria-hidden="true"></div>
      <div id="status" class="status" aria-live="polite"></div>
    </main>

    <script>
      const grid = document.getElementById("grid");
      const sentinel = document.getElementById("sentinel");
      const statusEl = document.getElementById("status");

      let page = 1;
      let loading = false;
      let hasMore = true;

      function el(tag, attrs = {}) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (v === undefined || v === null || v === "") continue;
          node.setAttribute(k, v);
        }
        return node;
      }

      function renderItems(items) {
  const frag = document.createDocumentFragment();

  // Each item includes layout (1/2/3) from the endpoint
  // Group into rows by reading sequentially:
  for (let i = 0; i < items.length; ) {
    const layout = Number(items[i].layout || 1);

    const row = document.createElement("div");
    row.className = "row";
    row.dataset.layout = String(layout);

    const take = Math.min(layout, items.length - i);
    for (let j = 0; j < take; j++) {
      const it = items[i + j];
      const img = document.createElement("img");
      img.src = it.src;
      img.alt = it.alt || "";
      img.loading = "lazy";
      img.decoding = "async";
      if (it.w) img.width = it.w;
      if (it.h) img.height = it.h;
      row.appendChild(img);
    }

    frag.appendChild(row);
    i += take;
  }

  grid.appendChild(frag);
}
      async function loadNext() {
        if (loading || !hasMore) return;
        loading = true;
        statusEl.textContent = "Loading…";

        try {
          const res = await fetch(`/api/feed.json?page=${page}&pageSize=36`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          renderItems(data.items);
          hasMore = Boolean(data.hasMore);
          page += 1;

          statusEl.textContent = hasMore ? "" : "End.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Couldn’t load more.";
        } finally {
          loading = false;
        }
      }

      const io = new IntersectionObserver(
        (entries) => {
          if (entries.some((e) => e.isIntersecting)) loadNext();
        },
        { rootMargin: "800px" }
      );

      io.observe(sentinel);
      loadNext();
    </script>
  </body>
</html>
