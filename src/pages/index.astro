<script>
  const grid = document.getElementById("grid");
  const sentinel = document.getElementById("sentinel");
  const statusEl = document.getElementById("status");

  let page = 1;
  let loading = false;
  let hasMore = true;

  function createImageNode(it) {
    const img = document.createElement("img");
    img.src = it.src;
    img.alt = it.alt || "";
    img.loading = "lazy";
    img.decoding = "async";
    if (it.w) img.width = it.w;
    if (it.h) img.height = it.h;

    // If there is a link, wrap image in <a> that opens new tab
    if (it.link) {
      const a = document.createElement("a");
      a.href = it.link;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.appendChild(img);
      return a;
    }

    return img;
  }

  function renderRows(rows) {
    const frag = document.createDocumentFragment();

    for (const rowData of rows) {
      const row = document.createElement("div");
      row.className = "row";

      const items = Array.isArray(rowData.items) ? rowData.items : [];
      // forgiving: if layout wrong/missing, derive from count
      const layout = Number(rowData.layout) || Math.min(3, Math.max(1, items.length));
      row.dataset.layout = String(layout);

      for (const it of items) {
        row.appendChild(createImageNode(it));
      }

      frag.appendChild(row);
    }

    grid.appendChild(frag);
  }

  async function loadNext() {
    if (loading || !hasMore) return;
    loading = true;
    if (statusEl) statusEl.textContent = "Loading…";

    try {
      const res = await fetch(`/api/feed.json?page=${page}&pageSize=12`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const rows = Array.isArray(data.rows) ? data.rows : [];
      renderRows(rows);

      hasMore = Boolean(data.hasMore);
      page += 1;

      if (statusEl) statusEl.textContent = hasMore ? "" : "";
      if (!hasMore && io) io.disconnect(); // stop observing at the end
    } catch (err) {
      console.error(err);
      if (statusEl) statusEl.textContent = "Couldn’t load more.";
    } finally {
      loading = false;
    }
  }

  // Make sure sentinel exists
  if (!sentinel) {
    console.error("Missing #sentinel element. Infinite scroll disabled.");
  }

  const io = sentinel
    ? new IntersectionObserver(
        (entries) => {
          if (entries.some((e) => e.isIntersecting)) loadNext();
        },
        { rootMargin: "900px" }
      )
    : null;

  if (io && sentinel) io.observe(sentinel);

  // initial load
  loadNext();
</script>
